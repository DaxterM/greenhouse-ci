#!/usr/bin/env bash

set -ex

version=${1:?"Stemcell Version is required"}
path_arg=${2:?"VMDK is required"}
tmp_path=`mktemp -d -t bosh-stemcell`
vmdk_path=$tmp_path/image-disk1.vmdk
mv $path_arg $vmdk_path
chmod +x $vmdk_path
vmdk_bytes=`wc -c $vmdk_path | while read size name; do echo $size; done`
cat > $tmp_path/image.ovf <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!--Generated by VMware VirtualCenter Server, User: root, UTC time: 2016-01-20T19:00:00.708008Z-->
<Envelope vmw:buildId="build-2001466" xmlns="http://schemas.dmtf.org/ovf/envelope/1" xmlns:cim="http://schemas.dmtf.org/wbem/wscim/1/common" xmlns:ovf="http://schemas.dmtf.org/ovf/envelope/1" xmlns:rasd="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/CIM_ResourceAllocationSettingData" xmlns:vmw="http://www.vmware.com/schema/ovf" xmlns:vssd="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/CIM_VirtualSystemSettingData" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <References>
    <File ovf:href="image-disk1.vmdk" ovf:id="file1" ovf:size="$vmdk_bytes" />
  </References>
  <DiskSection>
    <Info>Virtual disk information</Info>
    <Disk ovf:capacity="50" ovf:capacityAllocationUnits="byte * 2^30" ovf:diskId="vmdisk1" ovf:fileRef="file1" ovf:format="http://www.vmware.com/interfaces/specifications/vmdk.html#streamOptimized" ovf:populatedSize="8156938240" />
  </DiskSection>
  <NetworkSection>
    <Info>The list of logical networks</Info>
    <Network ovf:name="stonetalon">
      <Description>The stonetalon network</Description>
    </Network>
  </NetworkSection>
  <VirtualSystem ovf:id="greenhouse-stemcell">
    <Info>A virtual machine</Info>
    <Name>greenhouse-stemcell</Name>
    <OperatingSystemSection ovf:id="112" vmw:osType="windows8Server64Guest">
      <Info>The kind of installed guest operating system</Info>
      <Description>Microsoft Windows Server 2012 (64-bit)</Description>
    </OperatingSystemSection>
    <VirtualHardwareSection>
      <Info>Virtual hardware requirements</Info>
      <System>
        <vssd:ElementName>Virtual Hardware Family</vssd:ElementName>
        <vssd:InstanceID>0</vssd:InstanceID>
        <vssd:VirtualSystemIdentifier>greenhouse-stemcell</vssd:VirtualSystemIdentifier>
        <vssd:VirtualSystemType>vmx-08</vssd:VirtualSystemType>
      </System>
      <Item>
        <rasd:AllocationUnits>hertz * 10^6</rasd:AllocationUnits>
        <rasd:Description>Number of Virtual CPUs</rasd:Description>
        <rasd:ElementName>1 virtual CPU(s)</rasd:ElementName>
        <rasd:InstanceID>1</rasd:InstanceID>
        <rasd:ResourceType>3</rasd:ResourceType>
        <rasd:VirtualQuantity>1</rasd:VirtualQuantity>
      </Item>
      <Item>
        <rasd:AllocationUnits>byte * 2^20</rasd:AllocationUnits>
        <rasd:Description>Memory Size</rasd:Description>
        <rasd:ElementName>4096MB of memory</rasd:ElementName>
        <rasd:InstanceID>2</rasd:InstanceID>
        <rasd:ResourceType>4</rasd:ResourceType>
        <rasd:VirtualQuantity>4096</rasd:VirtualQuantity>
      </Item>
      <Item>
        <rasd:Address>0</rasd:Address>
        <rasd:Description>SCSI Controller</rasd:Description>
        <rasd:ElementName>SCSI controller 0</rasd:ElementName>
        <rasd:InstanceID>3</rasd:InstanceID>
        <rasd:ResourceSubType>lsilogicsas</rasd:ResourceSubType>
        <rasd:ResourceType>6</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="slotInfo.pciSlotNumber" vmw:value="160" />
      </Item>
      <Item>
        <rasd:Address>1</rasd:Address>
        <rasd:Description>IDE Controller</rasd:Description>
        <rasd:ElementName>IDE 1</rasd:ElementName>
        <rasd:InstanceID>4</rasd:InstanceID>
        <rasd:ResourceType>5</rasd:ResourceType>
      </Item>
      <Item>
        <rasd:Address>0</rasd:Address>
        <rasd:Description>IDE Controller</rasd:Description>
        <rasd:ElementName>IDE 0</rasd:ElementName>
        <rasd:InstanceID>5</rasd:InstanceID>
        <rasd:ResourceType>5</rasd:ResourceType>
      </Item>
      <Item ovf:required="false">
        <rasd:AutomaticAllocation>false</rasd:AutomaticAllocation>
        <rasd:ElementName>Video card</rasd:ElementName>
        <rasd:InstanceID>6</rasd:InstanceID>
        <rasd:ResourceType>24</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="enable3DSupport" vmw:value="false" />
        <vmw:Config ovf:required="false" vmw:key="use3dRenderer" vmw:value="automatic" />
        <vmw:Config ovf:required="false" vmw:key="useAutoDetect" vmw:value="false" />
        <vmw:Config ovf:required="false" vmw:key="videoRamSizeInKB" vmw:value="4096" />
      </Item>
      <Item ovf:required="false">
        <rasd:AutomaticAllocation>false</rasd:AutomaticAllocation>
        <rasd:ElementName>VMCI device</rasd:ElementName>
        <rasd:InstanceID>7</rasd:InstanceID>
        <rasd:ResourceSubType>vmware.vmci</rasd:ResourceSubType>
        <rasd:ResourceType>1</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="allowUnrestrictedCommunication" vmw:value="false" />
        <vmw:Config ovf:required="false" vmw:key="slotInfo.pciSlotNumber" vmw:value="33" />
      </Item>
      <Item ovf:required="false">
        <rasd:AddressOnParent>0</rasd:AddressOnParent>
        <rasd:AutomaticAllocation>false</rasd:AutomaticAllocation>
        <rasd:ElementName>CD/DVD drive 1</rasd:ElementName>
        <rasd:InstanceID>8</rasd:InstanceID>
        <rasd:Parent>4</rasd:Parent>
        <rasd:ResourceSubType>vmware.cdrom.remotepassthrough</rasd:ResourceSubType>
        <rasd:ResourceType>15</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="backing.exclusive" vmw:value="false" />
      </Item>
      <Item>
        <rasd:AddressOnParent>0</rasd:AddressOnParent>
        <rasd:ElementName>Hard disk 1</rasd:ElementName>
        <rasd:HostResource>ovf:/disk/vmdisk1</rasd:HostResource>
        <rasd:InstanceID>9</rasd:InstanceID>
        <rasd:Parent>3</rasd:Parent>
        <rasd:ResourceType>17</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="backing.writeThrough" vmw:value="false" />
      </Item>
      <Item ovf:required="false">
        <rasd:AddressOnParent>0</rasd:AddressOnParent>
        <rasd:AutomaticAllocation>false</rasd:AutomaticAllocation>
        <rasd:Description>Floppy Drive</rasd:Description>
        <rasd:ElementName>Floppy drive 1</rasd:ElementName>
        <rasd:InstanceID>10</rasd:InstanceID>
        <rasd:ResourceSubType>vmware.floppy.remotedevice</rasd:ResourceSubType>
        <rasd:ResourceType>14</rasd:ResourceType>
      </Item>
      <Item>
        <rasd:AddressOnParent>7</rasd:AddressOnParent>
        <rasd:AutomaticAllocation>true</rasd:AutomaticAllocation>
        <rasd:Connection>stonetalon</rasd:Connection>
        <rasd:Description>E1000 ethernet adapter on "stonetalon"</rasd:Description>
        <rasd:ElementName>Network adapter 1</rasd:ElementName>
        <rasd:InstanceID>11</rasd:InstanceID>
        <rasd:ResourceSubType>E1000</rasd:ResourceSubType>
        <rasd:ResourceType>10</rasd:ResourceType>
        <vmw:Config ovf:required="false" vmw:key="slotInfo.pciSlotNumber" vmw:value="32" />
        <vmw:Config ovf:required="false" vmw:key="wakeOnLanEnabled" vmw:value="true" />
      </Item>
      <vmw:Config ovf:required="false" vmw:key="cpuHotAddEnabled" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="cpuHotRemoveEnabled" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="firmware" vmw:value="bios" />
      <vmw:Config ovf:required="false" vmw:key="virtualICH7MPresent" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="virtualSMCPresent" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="memoryHotAddEnabled" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="nestedHVEnabled" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="powerOpInfo.powerOffType" vmw:value="soft" />
      <vmw:Config ovf:required="false" vmw:key="powerOpInfo.resetType" vmw:value="soft" />
      <vmw:Config ovf:required="false" vmw:key="powerOpInfo.standbyAction" vmw:value="checkpoint" />
      <vmw:Config ovf:required="false" vmw:key="powerOpInfo.suspendType" vmw:value="hard" />
      <vmw:Config ovf:required="false" vmw:key="tools.afterPowerOn" vmw:value="true" />
      <vmw:Config ovf:required="false" vmw:key="tools.afterResume" vmw:value="true" />
      <vmw:Config ovf:required="false" vmw:key="tools.beforeGuestShutdown" vmw:value="true" />
      <vmw:Config ovf:required="false" vmw:key="tools.beforeGuestStandby" vmw:value="true" />
      <vmw:Config ovf:required="false" vmw:key="tools.syncTimeWithHost" vmw:value="false" />
      <vmw:Config ovf:required="false" vmw:key="tools.toolsUpgradePolicy" vmw:value="manual" />
    </VirtualHardwareSection>
  </VirtualSystem>
</Envelope>
EOF

vmdk_sha=`shasum -a1 $vmdk_path | cut -d ' ' -f 1`
ovf_sha=`shasum -a1 $tmp_path/image.ovf | cut -d ' ' -f 1`
cat > $tmp_path/image.mf <<EOF
SHA1(image-disk1.vmdk)=$vmdk_sha
SHA1(image.ovf)=$ovf_sha
EOF

tar -cvzf $tmp_path/image -C $tmp_path image.mf image.ovf image-disk1.vmdk
image_sha=`shasum -a1 $tmp_path/image | cut -d ' ' -f 1`

cat > $tmp_path/stemcell.MF <<EOF
---
name: bosh-vsphere-esxi-windows-2012R2-go_agent
version: '$version'
bosh_protocol: 1
sha1: $image_sha
operating_system: windows
cloud_properties:
  name: bosh-vsphere-esxi-ubuntu-trusty-go_agent
  version: '3181'
  infrastructure: vsphere
  hypervisor: esxi
  disk: 3072
  disk_format: ovf
  container_format: bare
  os_type: linux
  os_distro: ubuntu
  architecture: x86_64
  root_device_name: /dev/sda1
EOF

cat > $tmp_path/apply_spec.yml <<EOF
{"deployment":"micro","release":{"name":"micro","version":9},"properties":{"micro":true,"nats":{"user":"nats","password":"nats","auth_timeout":3,"address":"127.0.0.1","listen_address":"0.0.0.0","port":4222,"no_epoll":false,"no_kqueue":true,"ping_interval":5,"ping_max_outstanding":2,"http":{"port":9222}},"redis":{"address":"127.0.0.1","password":"redis","port":25255,"listen_address":"127.0.0.1","loglevel":"info"},"postgres":{"user":"postgres","password":"postges","host":"127.0.0.1","listen_address":"127.0.0.1","database":"bosh","port":5432,"additional_databases":[],"adapter":"postgres","connection_options":{"max_connections":32,"pool_timeout":10}},"blobstore":{"address":"127.0.0.1","director":{"user":"director","password":"director"},"agent":{"user":"agent","password":"agent"},"port":25250,"backend_port":25251,"max_upload_size":"5000m","provider":"dav","s3_region":"us-east-1","credentials_source":"static","use_ssl":true,"s3_port":443,"s3_force_path_style":false,"ssl_verify_peer":true,"s3_multipart_threshold":16777216},"director":{"address":"127.0.0.1","name":"micro","port":25555,"db":{"user":"postgres","password":"postges","host":"127.0.0.1","listen_address":"127.0.0.1","database":"bosh","port":5432,"additional_databases":[],"adapter":"postgres","connection_options":{"max_connections":32,"pool_timeout":10}},"backend_port":25556,"nginx":{"workers":2,"ssl_prefer_server_ciphers":true,"ssl_protocols":"TLSv1 TLSv1.1 TLSv1.2","ssl_ciphers":"ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK"},"timeout":7200,"proxy_timeout":900,"max_upload_size":"10000m","encryption":false,"max_tasks":100,"max_threads":32,"enable_snapshots":false,"snapshot_schedule":"0 0 7 * * * UTC","self_snapshot_schedule":"0 0 6 * * * UTC","auto_fix_stateful_nodes":true,"max_vm_create_tries":5,"debug":{"keep_unreachable_vms":false},"disks":{"max_orphaned_age_in_days":5,"cleanup_schedule":"0 0,30 * * * * UTC"},"user_management":{"provider":"local"},"default_ssh_options":{"gateway_user":"vcap"},"ignore_missing_gateway":false,"trusted_certs":""},"hm":{"http":{"user":"hm","password":"hm","port":25923},"director_account":{"user":"admin","password":"admin","client_id":"","client_secret":"","ca_cert":""},"intervals":{"log_stats":300,"agent_timeout":180,"rogue_agent_alert":180,"prune_events":30,"poll_director":60,"poll_grace_period":30,"analyze_agents":60},"loglevel":"info","email_notifications":false,"tsdb_enabled":false,"pagerduty_enabled":false,"cloud_watch_enabled":false,"resurrector_enabled":false,"resurrector":{"minimum_down_jobs":5,"percent_threshold":0.2,"time_threshold":600},"datadog_enabled":false,"graphite_enabled":false,"consul_event_forwarder_enabled":false,"consul_event_forwarder":{"port":8500,"protocol":"http","ttl_note":"Automatically Registered by Bosh-Monitor","events":false,"heartbeats_as_alerts":false},"syslog_event_forwarder_enabled":false,"syslog_event_forwarder":{"port":5514,"transport":"tcp"}},"dns":{"address":"127.0.0.1","domain_name":"microbosh","db":{"user":"postgres","password":"postges","host":"127.0.0.1","listen_address":"127.0.0.1","database":"bosh","port":5432,"additional_databases":[],"adapter":"postgres","connection_options":{"max_connections":32,"pool_timeout":10}},"distributor_threads":2,"receiver_threads":2,"webserver":{"port":8081,"address":"0.0.0.0"}},"compiled_package_cache":{"provider":"s3","options":{"credentials_source":"static","port":25250,"use_ssl":true,"ssl_verify_peer":true,"s3_port":443,"s3_force_path_style":false,"s3_multipart_threshold":16777216}},"ntp":["0.pool.ntp.org","1.pool.ntp.org"],"agent":{"blobstore":{"credentials_source":"static","s3_region":"us-east-1","use_ssl":true,"ssl_verify_peer":true,"s3_force_path_style":false,"s3_multipart_threshold":16777216}},"registry":{"http":{"port":25777}},"aws":{"credentials_source":"static","max_retries":2,"http_read_timeout":60,"http_wire_trace":false},"openstack":{"endpoint_type":"publicURL","state_timeout":300,"boot_from_volume":false,"stemcell_public_visibility":false,"wait_resource_poll_interval":5,"use_dhcp":true,"ignore_server_availability_zone":false},"vcd":{"entities":{"vm_metadata_key":"vcd-cf","description":"vcd-cf"}},"event_nats_enabled":false},"index":0,"packages":{"ruby":{"name":"ruby","version":"030e3d4eafd00b10bbfa879bcf44fba62139205e","sha1":"0b28bf7bac8cb57e0a67863db3ba0452bdb5aa37","blobstore_id":"e21eddc4-e018-4212-5202-febd0ce4c772"},"nats":{"name":"nats","version":"6a31c7bb0d5ffa2a9f43c7fd7193193438e20e92","sha1":"adb841abb665fe6a112adf8d916d62209f608231","blobstore_id":"cfdc3a94-e8e2-4806-6d67-52f8f5789577"},"redis":{"name":"redis","version":"37eae530889cb9ef4e84f9c3d0827bab5ae5cb66","sha1":"da0f8dfe391b336a5bd5d0b8529445152ae76005","blobstore_id":"98a4bc92-beb9-4122-46ad-77c9e1f587a7"},"postgres":{"name":"postgres","version":"55dbf1828bbb8e5fcd7dc7550cfb73de89312458","sha1":"05e2a6a135179bee8a7b28b21d273948ad0a9de5","blobstore_id":"28aac154-9bd4-4ef9-43ba-ec40f3b197b5"},"powerdns":{"name":"powerdns","version":"256336d00b1689138490c385c03ad3a8f54b4a9e","sha1":"1a600629acd2d1e07e1155b3612e2ffeedf54644","blobstore_id":"ce63b0c0-c1cb-4b79-567b-55d73402a549"},"nginx":{"name":"nginx","version":"1d356bbd17ed8c349fd1053093222d78559687ec","sha1":"d87662b519de2531f88e26b7507659b5a569a27b","blobstore_id":"fd9840ed-2c5e-4315-61cd-6f0bd3d3f0a7"},"libpq":{"name":"libpq","version":"09c8f60b87c9bd41b37b0f62159c9d77163f52b8","sha1":"2398a7a98afcebe6336bf9a40b0984a1e08ab04d","blobstore_id":"e287580e-6cb2-44aa-6936-54513112e269"},"mysql":{"name":"mysql","version":"205d264a914bb12a78fd5445cc2299579e630bd4","sha1":"c4e7976499484b836a5d89f0a18958116a3faaa3","blobstore_id":"85cb3996-eac8-4144-5551-e0076b6870ad"},"director":{"name":"director","version":"8ad424130cd22081dc6c533bc374bc13da0dc33a","sha1":"765ce64ec1ef03c6347fb934df551b986e47e176","blobstore_id":"3407e950-5660-4f74-6d11-28428a9089ab"},"genisoimage":{"name":"genisoimage","version":"008d332ba1471bccf9d9aeb64c258fdd4bf76201","sha1":"da7ac2473bee23e6bef7e7ec908415320efdb41e","blobstore_id":"ea573471-5b71-4e05-476f-4b942490d59f"},"health_monitor":{"name":"health_monitor","version":"2ddc2d2917184f6328490aa0ec22c8c1e28c398d","sha1":"48fb3fc62aa7dd0e30044d11cacc9a3171e82717","blobstore_id":"3fdbd227-f214-4ab5-5047-744acbbde7c2"}},"configuration_hash":{},"networks":{"local":{"ip":"127.0.0.1"}},"job":{"name":"micro_vsphere","templates":[{"name":"nats","version":"329a9df8c4b7d3655c57e59d8fe2a03d65843cac","sha1":"73de8659da15387295b879d8190c2d6d79037ac8","blobstore_id":"788fc219-68db-4c04-abbb-04033419a37c"},{"name":"redis","version":"708da93eea8f2c36fd576d6b349e78ab80bdedfa","sha1":"e754e430b46a15dce645310c01ff0e985ae60faa","blobstore_id":"aa4c3c93-3c35-433a-bbc2-081957035aa4"},{"name":"postgres","version":"24fe5261816d5bf75caab258ce1b2ee15b4ad2e0","sha1":"a7003a2811a052fe89c514fe29e2f5dc0024b074","blobstore_id":"97361285-6fe8-4c8b-8c85-6fbb9143d624"},{"name":"powerdns","version":"df20bcfaa20062ef2e0136f6b6a5dbdc62f7b6a8","sha1":"6758d5bd60c6f21a852a42fac9ed0bd52915b748","blobstore_id":"2057e375-99a0-4911-a829-3796b610b1d6"},{"name":"blobstore","version":"267710c9165f827561b14b020c1181b098df27cf","sha1":"b22a7964c3660eaf654442707e998c8afe18b145","blobstore_id":"1ddd1303-ef11-4ed4-b2a1-c7d2adfaaf51"},{"name":"director","version":"0f99de1633d54d6c66dac8f6467daa28291fb166","sha1":"0259e66c440ed57d10dd9d8461ed067b22008f72","blobstore_id":"be5d0f6a-14e6-43b5-929a-9d6874427082"},{"name":"health_monitor","version":"75524cc153e63fc9609e33d79e4b0b173a93f6b8","sha1":"41ca5832ef4f68365285ed402f07fd158cb9a622","blobstore_id":"30179e0f-cd42-473b-a4db-f6f45db78448"}]}}
EOF

tar -czvf ./bosh-stemcell-$version-vsphere-esxi-windows2012R2-go_agent.tgz -C $tmp_path apply_spec.yml stemcell.MF image
